const multiSiteOriginKey = 'RAZER_MULTI_SITE_ORIGIN';
let siteSelectionCountryData;
try {
    const isCsrDisabled = document.querySelector('cx-storefront[data-csr-disabled]');
    const endpoint = document.querySelector('.site-selector-challenge-popup[data-geo-endpoint]');
    if (isCsrDisabled && endpoint && (!document.cookie || !document.cookie.includes('hideSiteSelectorPopup'))) {
        const geoEndpoint = endpoint?.getAttribute('data-geo-endpoint');
        fetch(geoEndpoint).then(response => response.json()).then(geoData => {
            const browsingFromCountry = geoData.country ? geoData.country.isocode : '';
            if (browsingFromCountry) {
                initSiteSelectorButtonsEvents();
                checkCurrentCountry(browsingFromCountry, RAZER_BASE_STORE_DATA, RAZER_CONTINENTS);
            }
        });
    }
    updateCountryIsoCookie();
    processCountryQueryParam();
} catch (e) { }


function initSiteSelectorButtonsEvents() {
    document.addEventListener('click', function (event) {
        let siteNavDataElement = event.target.matches('button.goto-suggested-site') || event.target.closest('button.goto-suggested-site');
        if (siteNavDataElement === true) {
            siteNavDataElement = event.target;
        }

        if (siteNavDataElement) {
            event.preventDefault();
            const navUrl = siteNavDataElement?.getAttribute('data-product-target-url')?.replace(/([^:]\/)\/+/g, "$1");
            const navCountryCode = siteNavDataElement?.getAttribute('data-country-code');

            if (navUrl && navCountryCode) {
                updateMultiSiteOrigin(navCountryCode);
                document.cookie = 'razer_site_data=' + navCountryCode + '; path=/; domain=.razer.com;';
                document.location.href = navUrl;
            }
            return;
        }

        if (
            event.target.matches('.disable-suggested-site-popup') ||
            event.target.closest('.disable-suggested-site-popup')
        ) {
            event.preventDefault();
            disableSiteSelector();
            return;
        }
    }, true);

    document.querySelector('.disable-suggested-site-popup')?.addEventListener('keydown', (e) => {
        if ((e.key === 'Enter') || (e.key === ' ')) {
            e.preventDefault();
            disableSiteSelector();
            return;
        }
    });
}

function disableSiteSelector() {
    const siteHeader = document.querySelector('header');
    const spaElement = document.querySelector('cx-storefront');
    const navUrl = document.querySelector('button.goto-suggested-site')?.getAttribute('data-product-target-url');
    const navCountryCode = document.querySelector('button.goto-suggested-site')?.getAttribute('data-country-code');

    if (navUrl && navCountryCode) {
        document.cookie = 'hideSiteSelectorPopup=true; path=/;';
        document.body.classList.remove('with-banner');
        document.querySelector('app-razer-site-selector-challenge').setAttribute('hidden', 'true');
    }
    document.body.classList.remove('multi-site-popup');
    siteHeader.style.removeProperty('top');
    spaElement.style.removeProperty('padding');
}

function checkCurrentCountry(browsingFromCountry, baseStore, continents) {
    let country = findMatchingCountry(continents, browsingFromCountry);
    let multiSiteOriginData = localStorage.getItem(multiSiteOriginKey);
    const isSameSite = !(baseStore.deliveryCountries !== null && browsingFromADifferentCountry(browsingFromCountry, baseStore.deliveryCountries));
    const baseUrl = document.querySelector('.site-selector-challenge-popup').getAttribute('data-base-country-url').replace(new RegExp('/', 'g'), '');
    if (multiSiteOriginData) {
        multiSiteOriginData = JSON.parse(multiSiteOriginData);
    }

    const isBrowsingFromADifferentCountry = baseStore.deliveryCountries !== null &&
        (!isSameSite || (country.length > 1 && !multiSiteOriginData?.find(site => site.isocode === browsingFromCountry)));

    if (isBrowsingFromADifferentCountry && country?.length && document.querySelector('.site-selector-challenge-popup')) {
        country = country.filter(site => (!baseUrl || !site.siteUrl.includes(baseUrl)));
        siteSelectionCountryData = country;
        enablePopup(country, isSameSite);
        resetPopupOnResize();
        positionPopupSlot();
    }
}

function resetPopupOnResize() {
    window.addEventListener('resize', () => {
        positionPopupSlot();
    });
}

function positionPopupSlot() {
    const headerElement = document.querySelector('header > .header');
    const topHeaderElement = document.querySelector('.TopHeaderSlot');
    const multiSiteElement = document.querySelector('app-razer-site-selector-challenge .site-selector-challenge-popup');
    const sitePopupHeight = document.querySelector('.with-banner.multi-site-popup app-razer-site-selector-challenge .site-selector-challenge-popup')?.clientHeight;
    const siteHeader = document.querySelector('header');
    const spaElement = document.querySelector('cx-storefront');

    if (sitePopupHeight && siteSelectionCountryData?.length > 1 && isTabletView() && topHeaderElement && multiSiteElement) {
        siteHeader.style.top = sitePopupHeight + 'px';
        spaElement.style.padding = sitePopupHeight + 'px 0 0 0';
    } else if (siteSelectionCountryData?.length > 1 && isMobileView() && topHeaderElement && multiSiteElement) {
        document.querySelector('cx-storefront').insertBefore(topHeaderElement, document.querySelector('#tos-razer'));
        siteHeader.style.removeProperty('top');
        spaElement.style.removeProperty('padding');
    } else if (siteHeader && spaElement) {
        siteHeader.style.removeProperty('top');
        spaElement.style.removeProperty('padding');

        if (headerElement && topHeaderElement) {
            headerElement.insertBefore(topHeaderElement, headerElement.children[0]);
        }
    }
}

function enablePopup(country, isSameSite) {
    updateApSiteName();
    const suggestedNavButtonsContainer = document.querySelector(('.site-switch-btns'));
    const suggetedPopup = document.querySelector('.site-selector-challenge-popup');
    const leftColumn = suggetedPopup.querySelector('.left-column');
    const rightColumn = suggetedPopup.querySelector('.right-column');
    document.body.classList.add('with-banner');
    suggetedPopup.removeAttribute('hidden');

    if (suggestedNavButtonsContainer) {
        let siteButtonsHtml = '';
        const buttonText = document.querySelector('.site-switch-btns').getAttribute('data-translate') || 'Switch to <span class=&quot;switch-country&quot;>siteName</span>language'
        country.forEach(function (site) {
            let currentButtonText = buttonText.replace('siteName', site.name);
            if (country.length === 1 && !isSameSite) {
                currentButtonText = currentButtonText.replace('language', '');
            } else {
                currentButtonText = currentButtonText.replace('language', (' <span class="site-language">' + site.language?.name + '</span>'));
            }

            siteButtonsHtml += `<button 
                class="goto-suggested-site btn btn-primary pl-4 pr-4 pl-lg-5 pr-lg-5 remove-br" 
                data-country-code="${site.isocode}" 
                data-product-target-url="${getSuggestedNavUrl(site.siteUrl)}">
                    ${currentButtonText}
            </button>`;
        });

        suggestedNavButtonsContainer.innerHTML = siteButtonsHtml;

        if (isSameSite && country.length === 1) {
            document.querySelector('.site-switch-btns').classList.add('same-site-button');
        }
    }

    if (country.length === 1) {
        leftColumn?.classList.add('col-md-7');
        leftColumn?.classList.add('col-lg-8');
        leftColumn?.classList.remove('col-md-6');
        leftColumn?.classList.remove('col-lg-6');
        rightColumn?.classList.add('col-md-5');
        rightColumn?.classList.add('col-lg-4');
        rightColumn?.classList.remove('col-md-6');
        rightColumn?.classList.remove('col-lg-6');
        rightColumn?.classList.remove('multi-language');
    } else if (country.length !== 1) {
        leftColumn?.classList.remove('col-md-7');
        leftColumn?.classList.remove('col-lg-8');
        leftColumn?.classList.add('col-md-6');
        leftColumn?.classList.add('col-lg-6');
        rightColumn?.classList.remove('col-md-5');
        rightColumn?.classList.remove('col-lg-4');
        rightColumn?.classList.add('col-md-6');
        rightColumn?.classList.add('col-lg-6');
        rightColumn?.classList.add('multi-language');
        document.body.classList.add('multi-site-popup');
    }
}

function updateMultiSiteOrigin(isocode) {
    const currentSite = { isocode: isocode };
    let multiSiteOriginData = localStorage?.getItem(multiSiteOriginKey);

    if (multiSiteOriginData) {
        multiSiteOriginData = JSON.parse(multiSiteOriginData)?.filter(r => (r.site !== isocode));
        multiSiteOriginData = [currentSite].concat(multiSiteOriginData);
        localStorage.setItem(multiSiteOriginKey, JSON.stringify(multiSiteOriginData));
    } else {
        localStorage.setItem(multiSiteOriginKey, JSON.stringify([currentSite]));
    }
}

function updateApSiteName() {
    const apSiteCheck = window.location.pathname.includes('ap-en');
    if (apSiteCheck) {
        const apCountryData = RAZER_AP_SITE_DATA.sites.find(site => site.site === (getCookieValue('razer_site_data') || 'NZ'));

        if (apCountryData && apCountryData.name) {
            const siteSelectorCountry = document.querySelector('app-razer-site-selector-challenge .left-column .country span');
            const footerCountry = document.querySelector('footer .country-placeholder');

            if (siteSelectorCountry) {
                siteSelectorCountry.innerHTML = apCountryData.name;
            }

            if (footerCountry) {
                footerCountry.innerHTML = apCountryData.name;
            }
        }
    }
}

function getSuggestedNavUrl(siteUrl) {
    const countrySiteBaseUrl = document.querySelector('.site-selector-challenge-popup').getAttribute('data-base-country-url').replace(new RegExp('/', 'g'), '');
    const baseUrl = ensureProtocol(siteUrl);
    const currentPageUrl = document.location.pathname.replace(countrySiteBaseUrl, '');
    return baseUrl + currentPageUrl;
}

function ensureProtocol(url) {
    if (url && !url.match(/^https?:\/\/.*/g)) {
        url = 'https://' + url;
    }
    return url;
}

function findMatchingCountry(continents, browsingFromCountry) {
    const country = [];
    for (let i = 0; i < continents.length; i++) {
        const countries = continents[i].countries;
        for (let j = 0; j < countries.length; j++) {
            if (countries[j].isocode === browsingFromCountry) {
                country.push(countries[j]);
            }
        }
    }
    return country;
}

function browsingFromADifferentCountry(browsingFromCountry, deliveryCountries) {
    let differentCountry = true;
    const apSiteCheck = window.location.pathname.includes('ap-en');
    if (apSiteCheck) {
        const currentCurrency = RAZER_AP_SITE_DATA?.sites?.find(site => site.site === (getCookieValue('razer_site_data') || 'NZ'))?.isocode.currency;
        const currentCountry = deliveryCountries.find(site => site.isocode === browsingFromCountry);
        if (currentCountry && currentCountry.isocode) {
            const countryData = RAZER_AP_SITE_DATA?.sites?.find(site => site.isocode.currency === currentCurrency);

            if (countryData) {
                differentCountry = countryData.site !== currentCountry.isocode;
            }
        }
    } else {
        for (let i = 0; i < deliveryCountries.length && differentCountry; i++) {
            differentCountry = deliveryCountries[i].isocode !== browsingFromCountry;
        }
    }
    return differentCountry;
}


function processCountryQueryParam() {
    const coutryParam = 'country=';
    const url = document.location.href;

    if (url.includes(coutryParam)) {
        const countryCode = url.split(coutryParam)[1].split('&')[0];
        setCountryIsoCookie(countryCode);
    }
}

function setCountryIsoCookie(countryCode) {
    document.cookie = 'razer_site_data=' + countryCode + '; path=/; domain=.razer.com; secure=true;';
}

function updateCountryIsoCookie() {
    const defaultCountryIso = document.querySelector('cx-storefront')?.getAttribute('data-default-country-iso');
    let allCountriesIso = document.querySelector('cx-storefront')?.getAttribute('data-countries-iso')?.split(',');
    const storedSite = getCookieValue('razer_site_data');

    if ((storedSite && defaultCountryIso && allCountriesIso && allCountriesIso.length && !allCountriesIso.includes(storedSite)) || (!storedSite && defaultCountryIso)) {
        setCountryIsoCookie(defaultCountryIso);
    }

    updateApSiteName();
}